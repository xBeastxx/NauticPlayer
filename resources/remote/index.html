<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Nautic Remote</title>

    <!-- PWA / Fullscreen Mode Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Nautic Remote">
    <meta name="theme-color" content="#050505">
    <meta name="msapplication-navbutton-color" content="#050505">
    <meta name="apple-touch-fullscreen" content="yes">

    <!-- HLS.js for transcoding support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>

    <!-- Manifest for Android PWA -->
    <link rel="manifest" href="/manifest.json">

    <style>
        :root {
            --primary: #3b82f6;
            --primary-glow: rgba(59, 130, 246, 0.3);
            --bg: #050505;
            --surface: #1a1a1a;
            --surface-light: #252525;
            --text: #fff;
            --text-dim: rgba(255, 255, 255, 0.6);
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            touch-action: none;
            display: flex;
            flex-direction: column;
        }

        /* === CONNECTION STATUS BAR === */
        .status-bar {
            background: var(--surface);
            padding: 8px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 11px;
            color: var(--text-dim);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .status-dot.connecting {
            background: var(--warning);
        }

        .status-dot.disconnected {
            background: var(--danger);
            animation: none;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* === HEADER === */
        .header {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 50px;
        }

        .logo {
            font-size: 10px;
            font-weight: 800;
            letter-spacing: 2px;
            color: var(--primary);
            text-transform: uppercase;
        }

        .menu-btn {
            background: rgba(255, 255, 255, 0.08);
            border: none;
            color: #fff;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            transition: all 0.2s;
        }

        .menu-btn:active {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(0.95);
        }

        /* === MAIN CONTENT === */
        .main-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0 25px;
            text-align: center;
        }

        .file-title {
            font-size: 15px;
            line-height: 1.5;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 16px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            max-width: 100%;
            word-break: break-word;
        }

        .time-badge {
            font-family: 'SF Mono', 'Courier New', monospace;
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(145deg, var(--surface-light), var(--surface));
            padding: 12px 24px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        /* === CONTROL SHEET === */
        .control-sheet {
            background: linear-gradient(180deg, var(--surface) 0%, #111 100%);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            border-top-left-radius: 28px;
            border-top-right-radius: 28px;
            padding: 24px 20px calc(env(safe-area-inset-bottom) + 70px) 20px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
        }

        /* Seek Bar */
        .seek-wrapper {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .seek-times {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-dim);
            padding: 0 4px;
            font-family: 'SF Mono', monospace;
        }

        input[type=range] {
            width: 100%;
            -webkit-appearance: none;
            background: transparent;
            height: 24px;
            display: block;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 5px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 3px;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            background: #fff;
            border-radius: 50%;
            margin-top: -7px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        /* Primary Controls */
        .primary-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 24px;
        }

        .btn-circle {
            background: rgba(255, 255, 255, 0.08);
            border: none;
            border-radius: 50%;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            cursor: pointer;
        }

        .btn-circle:active {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(0.92);
        }

        .btn-sm {
            width: 48px;
            height: 48px;
        }

        .btn-lg {
            width: 72px;
            height: 72px;
            background: linear-gradient(145deg, #fff, #e0e0e0);
            color: #000;
            box-shadow: 0 4px 20px rgba(255, 255, 255, 0.15);
        }

        .btn-lg:active {
            background: #d0d0d0;
        }

        /* Volume Row */
        .volume-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0 auto;
            width: 85%;
            max-width: 280px;
        }

        .volume-row svg {
            flex-shrink: 0;
            opacity: 0.6;
        }

        /* Icons */
        .icon {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .icon-lg {
            width: 32px;
            height: 32px;
            fill: currentColor;
        }

        .icon-stroke {
            width: 22px;
            height: 22px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* === DRAWER (SIDEBAR) === */
        .drawer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
            backdrop-filter: blur(4px);
        }

        .drawer-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }

        .drawer {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 260px;
            background: var(--surface);
            transform: translateX(100%);
            transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            padding: 20px;
            display: flex;
            flex-direction: column;
            z-index: 101;
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.5);
        }

        .drawer.open {
            transform: translateX(0);
        }

        .drawer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .drawer-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
        }

        .drawer-close {
            background: rgba(255, 255, 255, 0.08);
            border: none;
            color: var(--text-dim);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .drawer-section {
            margin-bottom: 16px;
        }

        .drawer-section-title {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            padding-left: 4px;
        }

        .drawer-btn {
            background: transparent;
            border: none;
            color: #fff;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
            font-weight: 500;
            width: 100%;
            text-align: left;
            transition: background 0.15s;
        }

        .drawer-btn:active {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.2);
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--primary);
        }

        input:checked+.slider:before {
            transform: translateX(16px);
        }

        .drawer-btn svg {
            width: 18px;
            height: 18px;
            opacity: 0.7;
        }

        .drawer-btn .badge {
            margin-left: auto;
            color: var(--primary);
            font-weight: 600;
            font-size: 12px;
        }

        .drawer-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.08);
            margin: 12px 0;
        }

        /* === TRACK MODAL === */
        .modal {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 200;
            display: none;
            flex-direction: column;
        }

        .modal.show {
            display: flex;
            animation: slideUp 0.25s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            align-items: center;
        }

        .modal-title {
            font-weight: 700;
            flex: 1;
            text-align: center;
            font-size: 15px;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .track-list {
            overflow-y: auto;
            padding: 12px;
            flex: 1;
        }

        .track-row {
            padding: 14px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 13px;
            color: var(--text-dim);
            cursor: pointer;
            transition: background 0.15s;
            border-radius: 8px;
        }

        .track-row:active {
            background: rgba(255, 255, 255, 0.05);
        }

        .track-row.selected {
            color: var(--primary);
            font-weight: 700;
            background: rgba(59, 130, 246, 0.1);
        }

        .track-row.selected {
            color: var(--primary);
            font-weight: 700;
            background: rgba(59, 130, 246, 0.1);
        }

        /* === EXPLORER MODAL === */
        .explorer-breadcrumbs {
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.03);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 12px;
            color: var(--text-dim);
            white-space: nowrap;
            overflow-x: auto;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .breadcrumb-item {
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
        }

        .breadcrumb-sep {
            opacity: 0.4;
        }

        .file-list {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: background 0.15s;
        }

        .file-item:active {
            background: rgba(255, 255, 255, 0.08);
        }

        .file-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
            color: var(--text-dim);
        }

        .file-icon.folder {
            color: #fbbf24;
            /* Amber-400 */
            fill: currentColor;
        }

        .file-icon.video {
            color: #3b82f6;
            /* Blue-500 */
        }

        .file-info {
            flex: 1;
            overflow: hidden;
        }

        .file-name {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }

        .file-meta {
            font-size: 11px;
            color: var(--text-dim);
        }

        /* === RECONNECTION BANNER === */
        .reconnect-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--danger);
            color: #fff;
            padding: 12px 20px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            z-index: 1000;
            transform: translateY(-100%);
            transition: transform 0.3s;
        }

        .reconnect-banner.show {
            transform: translateY(0);
        }

        /* === LOADING STATE === */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 500;
        }

        .loading-overlay.show {
            display: flex;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* === WATCH MODE === */
        .watch-mode {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 2000;
            display: none;
            flex-direction: column;
        }

        .watch-mode.show {
            display: flex;
        }

        .watch-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.8);
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
        }

        .watch-back {
            background: none;
            border: none;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .watch-title {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            flex: 1;
            padding: 0 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .watch-video-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }

        .watch-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .watch-error {
            text-align: center;
            padding: 40px;
            color: var(--text-dim);
        }

        .watch-error h3 {
            color: #fff;
            margin-bottom: 12px;
            font-size: 18px;
        }

        .watch-error p {
            font-size: 14px;
            margin-bottom: 8px;
        }

        .watch-btn-stream {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border: none;
            color: #fff;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0 auto;
        }

        .stream-badge {
            background: linear-gradient(135deg, #10b981, #059669);
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 700;
            margin-left: 4px;
        }

        .watch-fullscreen-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .watch-fullscreen-btn:active {
            background: rgba(255, 255, 255, 0.2);
        }

        /* === INSTALL PROMPT === */
        .install-prompt {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 16px 20px;
            padding-bottom: calc(16px + env(safe-area-inset-bottom));
            display: none;
            flex-direction: column;
            gap: 12px;
            z-index: 3000;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            animation: slideUp 0.3s ease;
        }

        .install-prompt.show {
            display: flex;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .install-prompt-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .install-prompt-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .install-prompt-text {
            flex: 1;
        }

        .install-prompt-text h4 {
            margin: 0 0 4px 0;
            font-size: 15px;
            font-weight: 600;
        }

        .install-prompt-text p {
            margin: 0;
            font-size: 12px;
            color: var(--text-dim);
        }

        .install-prompt-close {
            background: none;
            border: none;
            color: var(--text-dim);
            padding: 8px;
            cursor: pointer;
        }

        .install-prompt-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border: none;
            color: #fff;
            padding: 12px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
        }

        .install-prompt-btn:active {
            opacity: 0.9;
        }

        /* === iOS ONBOARDING MODAL === */
        .onboarding-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 4000;
            display: none;
            flex-direction: column;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        .onboarding-modal.show {
            display: flex;
        }

        .onboarding-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
        }

        .onboarding-title {
            font-size: 17px;
            font-weight: 600;
        }

        .onboarding-close {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        .onboarding-step-info {
            color: var(--text-dim);
            font-size: 13px;
        }

        .onboarding-carousel {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        .onboarding-slide {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            max-width: 100%;
        }

        .onboarding-slide.active {
            display: flex;
        }

        .onboarding-slide img {
            max-width: 100%;
            max-height: 50vh;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .onboarding-slide-text {
            text-align: center;
            font-size: 15px;
            color: var(--text);
            line-height: 1.5;
            padding: 0 20px;
        }

        .onboarding-slide-text strong {
            color: var(--primary);
        }

        .onboarding-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            gap: 12px;
        }

        .onboarding-nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
        }

        .onboarding-nav-btn.primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .onboarding-nav-btn:disabled {
            opacity: 0.3;
        }

        .onboarding-dots {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .onboarding-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
        }

        .onboarding-dot.active {
            background: var(--primary);
        }
    </style>
</head>

<body>
    <!-- Install Prompt (PWA) -->
    <div class="install-prompt" id="install-prompt">
        <div class="install-prompt-content">
            <div class="install-prompt-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
            </div>
            <div class="install-prompt-text">
                <h4>Install Nautic Remote</h4>
                <p>Add to home screen for fullscreen experience</p>
            </div>
            <button class="install-prompt-close" onclick="dismissInstallPrompt()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <button class="install-prompt-btn" id="install-btn" onclick="installApp()">
            Install App
        </button>
    </div>

    <!-- styles for resume panel -->
    <style>
        .resume-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 6000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .resume-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .resume-card {
            background: var(--surface-2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 320px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .resume-overlay.show .resume-card {
            transform: scale(1);
        }

        .resume-time {
            font-size: 2em;
            font-weight: 700;
            margin: 10px 0 20px 0;
            color: var(--primary);
            font-variant-numeric: tabular-nums;
        }
    </style>

    <!-- Resume Prompt Panel (Centered) -->
    <div class="resume-overlay" id="resume-panel">
        <div class="resume-card">
            <h3 style="margin: 0; font-size: 1.1em; color: var(--text-dim)">Resume Playback?</h3>
            <div id="resume-text" class="resume-time">00:00</div>

            <div style="display: flex; gap: 12px;">
                <button class="btn"
                    style="flex: 1; background: var(--surface-3); color: var(--text); padding: 16px; font-size: 1.1em;"
                    onclick="window.dismissResume()">Start Over</button>
                <button class="btn"
                    style="flex: 1; background: var(--primary); color: white; padding: 16px; font-size: 1.1em;"
                    onclick="window.confirmResume()">Resume</button>
            </div>
        </div>
    </div>

    <!-- File Explorer Modal -->
    <div class="modal" id="explorer-modal">
        <div class="modal-header">
            <button class="modal-close" onclick="window.closeExplorer()">Cancel</button>
            <div class="modal-title">File Explorer</div>
            <div style="width: 40px"></div>
        </div>
        <div class="explorer-breadcrumbs" id="explorer-breadcrumbs">
            <!-- Breadcrumbs injected here -->
        </div>
        <div class="file-list" id="explorer-list">
            <!-- Files injected here -->
            <div class="loading-overlay" style="position: absolute; display: flex; background: transparent;">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <!-- iOS Onboarding Modal -->
    <div class="onboarding-modal" id="ios-onboarding">
        <div class="onboarding-header">
            <span class="onboarding-step-info" id="onboarding-step-info">Step 1 of 6</span>
            <span class="onboarding-title">Install Guide</span>
            <button class="onboarding-close" onclick="closeOnboarding()">Done</button>
        </div>

        <div class="onboarding-carousel">
            <div class="onboarding-slide active" data-step="1">
                <img src="/1.jpg" alt="Step 1">
                <div class="onboarding-slide-text">
                    Tap the <strong>three dots (â‹¯)</strong> in the address bar
                </div>
            </div>
            <div class="onboarding-slide" data-step="2">
                <img src="/2.jpg" alt="Step 2">
                <div class="onboarding-slide-text">
                    Tap <strong>"Compartir"</strong> (Share)
                </div>
            </div>
            <div class="onboarding-slide" data-step="3">
                <img src="/3.jpg" alt="Step 3">
                <div class="onboarding-slide-text">
                    Tap <strong>"MÃ¡s"</strong> (More) to see all options
                </div>
            </div>
            <div class="onboarding-slide" data-step="4">
                <img src="/4.jpg" alt="Step 4">
                <div class="onboarding-slide-text">
                    Scroll down and tap <strong>"Agregar a Inicio"</strong><br>(Add to Home Screen)
                </div>
            </div>
            <div class="onboarding-slide" data-step="5">
                <img src="/5.jpg" alt="Step 5">
                <div class="onboarding-slide-text">
                    Tap <strong>"Agregar"</strong> (Add) to install
                </div>
            </div>
            <div class="onboarding-slide" data-step="6">
                <img src="/6.jpg" alt="Step 6">
                <div class="onboarding-slide-text">
                    ðŸŽ‰ <strong>Done!</strong> Open the app from your home screen<br>for a fullscreen experience
                </div>
            </div>
        </div>

        <div class="onboarding-nav">
            <button class="onboarding-nav-btn" id="onboarding-prev" onclick="prevOnboardingStep()"
                disabled>Previous</button>
            <div class="onboarding-dots" id="onboarding-dots">
                <div class="onboarding-dot active"></div>
                <div class="onboarding-dot"></div>
                <div class="onboarding-dot"></div>
                <div class="onboarding-dot"></div>
                <div class="onboarding-dot"></div>
                <div class="onboarding-dot"></div>
            </div>
            <button class="onboarding-nav-btn primary" id="onboarding-next" onclick="nextOnboardingStep()">Next</button>
        </div>
    </div>

    <!-- Reconnection Banner -->
    <div class="reconnect-banner" id="reconnect-banner">
        Reconnecting...
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
    </div>

    <!-- Connection Status Bar -->
    <div class="status-bar">
        <div class="status-dot" id="status-dot"></div>
        <span id="status-text">Connecting...</span>
    </div>

    <!-- Header -->
    <div class="header">
        <!-- Watch on Phone (Left) -->
        <button class="menu-btn" onclick="openWatchMode(); vibrate('medium');" title="Watch on Phone">
            <svg class="icon-stroke" viewBox="0 0 24 24">
                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                <line x1="8" y1="21" x2="16" y2="21"></line>
                <line x1="12" y1="17" x2="12" y2="21"></line>
            </svg>
        </button>
        <div class="logo">NAUTIC REMOTE</div>
        <div style="display:flex; gap:8px; align-items:center;">
            <!-- PC Fullscreen Toggle (Quick Access) -->
            <button class="menu-btn" onclick="send('toggle-fullscreen'); vibrate('medium');"
                title="Toggle PC Fullscreen">
                <svg class="icon-stroke" viewBox="0 0 24 24">
                    <path
                        d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3">
                    </path>
                </svg>
            </button>
            <button class="menu-btn" onclick="window.openExplorer()">
                <svg class="icon-stroke" viewBox="0 0 24 24">
                    <path d="M3 7v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-6l-2-2H5a2 2 0 0 0-2 2z"></path>
                </svg>
            </button>
            <!-- Menu Button -->
            <button class="menu-btn" onclick="toggleDrawer()">
                <svg class="icon-stroke" viewBox="0 0 24 24">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-info">
        <div class="file-title" id="title">Connecting...</div>
        <img src="/icon.ico" alt="Nautic" style="width:80px; height:80px; margin:16px 0;">
        <div class="time-badge" id="time">--:--</div>
    </div>

    <!-- Control Sheet -->
    <div class="control-sheet">
        <!-- Seek Bar -->
        <div class="seek-wrapper">
            <input type="range" id="seek" min="0" max="1000" value="0">
            <div class="seek-times">
                <span id="time-current">00:00</span>
                <span id="time-duration">00:00</span>
            </div>
        </div>

        <!-- Primary Controls -->
        <div class="primary-controls">
            <!-- Seek -10s -->
            <button class="btn-circle btn-sm" onclick="send('seek', -10)">
                <svg class="icon-stroke" viewBox="0 0 24 24">
                    <polyline points="11 19 2 12 11 5"></polyline>
                    <polyline points="22 19 13 12 22 5"></polyline>
                </svg>
            </button>

            <!-- Play/Pause -->
            <button class="btn-circle btn-lg" id="btn-toggle" onclick="send('toggle')">
                <svg id="icon-play" class="icon-lg" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z" />
                </svg>
                <svg id="icon-pause" class="icon-lg" viewBox="0 0 24 24" style="display:none">
                    <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
                </svg>
            </button>

            <!-- Seek +10s -->
            <button class="btn-circle btn-sm" onclick="send('seek', 10)">
                <svg class="icon-stroke" viewBox="0 0 24 24">
                    <polyline points="13 19 22 12 13 5"></polyline>
                    <polyline points="2 19 11 12 2 5"></polyline>
                </svg>
            </button>
        </div>

        <!-- Volume Row -->
        <div class="volume-row">
            <svg class="icon-stroke" width="18" height="18" viewBox="0 0 24 24">
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            </svg>
            <input type="range" id="vol" min="0" max="100" value="100">
            <svg class="icon-stroke" width="18" height="18" viewBox="0 0 24 24">
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
            </svg>
        </div>
    </div>

    <!-- Drawer (Sidebar) -->
    <div class="drawer-overlay" id="overlay" onclick="toggleDrawer()"></div>
    <div class="drawer" id="drawer">
        <div class="drawer-header">
            <span class="drawer-title">Settings</span>
            <button class="drawer-close" onclick="toggleDrawer()">
                <svg class="icon-stroke" width="16" height="16" viewBox="0 0 24 24">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <!-- Tracks Section -->
        <div class="drawer-section">
            <div class="drawer-section-title">Tracks</div>
            <button class="drawer-btn" onclick="openTracks('audio')">
                <svg class="icon-stroke" viewBox="0 0 24 24">
                    <path d="M9 18V5l12-2v13"></path>
                    <circle cx="6" cy="18" r="3"></circle>
                    <circle cx="18" cy="16" r="3"></circle>
                </svg>
                Audio
                <span class="badge" id="count-audio">0</span>
            </button>
            <button class="drawer-btn" onclick="openTracks('sub')">
                <svg class="icon-stroke" viewBox="0 0 24 24">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                Subtitles
                <span class="badge" id="count-sub">0</span>
            </button>
        </div>

        <div class="drawer-divider"></div>

        <!-- Playback Section -->
        <div class="drawer-section">
            <div class="drawer-section-title">Playback</div>
            <button class="drawer-btn" onclick="send('command', ['cycle', 'loop-file']); toggleDrawer();">
                <svg class="icon-stroke" viewBox="0 0 24 24">
                    <polyline points="17 1 21 5 17 9"></polyline>
                    <path d="M3 11V9a4 4 0 0 1 4-4h14"></path>
                    <polyline points="7 23 3 19 7 15"></polyline>
                    <path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
                </svg>
                Loop Video
            </button>
            <button class="drawer-btn" onclick="send('mute'); toggleDrawer();">
                <svg class="icon-stroke" viewBox="0 0 24 24">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                    <line x1="23" y1="9" x2="17" y2="15"></line>
                    <line x1="17" y1="9" x2="23" y2="15"></line>
                </svg>
                Toggle Mute
            </button>
        </div>

        <div class="drawer-divider"></div>

        <!-- Window Section -->
        <div class="drawer-section">
            <div class="drawer-section-title">Window</div>
            <button class="drawer-btn" onclick="send('toggle-fullscreen'); toggleDrawer();">
                <svg class="icon-stroke" viewBox="0 0 24 24">
                    <path
                        d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3">
                    </path>
                </svg>
                Fullscreen
            </button>
        </div>

        <div class="drawer-divider"></div>

        <!-- Sync Section -->
        <div class="drawer-section">
            <div class="drawer-section-title">Connection</div>
            <button class="drawer-btn" id="btn-watch" onclick="openWatchMode()">
                <svg class="icon-stroke" viewBox="0 0 24 24">
                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                    <line x1="8" y1="21" x2="16" y2="21"></line>
                    <line x1="12" y1="17" x2="12" y2="21"></line>
                </svg>
                Watch on Phone
                <span class="stream-badge" id="stream-badge" style="display:none">LIVE</span>
            </button>
            <button class="drawer-btn" onclick="requestSync()">
                <svg class="icon-stroke" viewBox="0 0 24 24">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <polyline points="1 20 1 14 7 14"></polyline>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                </svg>
                Force Sync
            </button>
        </div>

        <div class="drawer-divider"></div>

        <!-- System Section -->
        <div class="drawer-section">
            <div class="drawer-section-title">System</div>
            <button class="drawer-btn" style="color: #ff4444" onclick="quitApp()">
                <svg class="icon-stroke" viewBox="0 0 24 24" style="color: #ff4444">
                    <path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
                    <line x1="12" y1="2" x2="12" y2="12"></line>
                </svg>
                Shut Down
            </button>
            <div
                style="display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; margin-bottom: 4px;">
                <span style="font-weight: 500; font-size: 13px; color: var(--text-dim);">Start with Windows</span>
                <label class="switch">
                    <input type="checkbox" id="autolaunch-toggle" onchange="toggleAutoLaunch(this.checked)">
                    <span class="slider round"></span>
                </label>
            </div>

        </div>
    </div>

    <!-- Track Modal -->
    <div class="modal" id="track-modal">
        <div class="modal-header">
            <span></span>
            <span class="modal-title" id="modal-title">Tracks</span>
            <button class="modal-close" onclick="closeModal()">Done</button>
        </div>
        <div class="track-list" id="track-container"></div>
    </div>

    <!-- Watch Mode Overlay -->
    <div class="watch-mode" id="watch-mode">
        <div class="watch-header">
            <button class="watch-back" onclick="closeWatchMode()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                Back
            </button>
            <div class="watch-title" id="watch-title">Loading...</div>
            <button class="watch-fullscreen-btn" onclick="toggleWatchFullscreen()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path
                        d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3">
                    </path>
                </svg>
            </button>
        </div>
        <div class="watch-video-container" id="watch-container">
            <video class="watch-video" id="watch-video" controls playsinline></video>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ============================================
        // STATE
        // ============================================
        let socket = null;
        let isConnected = false;
        let reconnectAttempts = 0;
        let isQuitting = false;
        const MAX_RECONNECT_ATTEMPTS = 10;

        // Player state
        let playerState = {
            time: 0,
            duration: 0,
            paused: true,
            volume: 100,
            muted: false,
            filename: 'No Media',
            tracks: []
        };

        // UI state
        let isDraggingSeek = false;
        let lastTimeUpdate = 0;

        // ============================================
        // DOM ELEMENTS
        // ============================================
        const elTime = document.getElementById('time');
        const elTimeCurrent = document.getElementById('time-current');
        const elTimeDuration = document.getElementById('time-duration');
        const elSeek = document.getElementById('seek');
        const elVol = document.getElementById('vol');
        const elTitle = document.getElementById('title');
        const elStatusDot = document.getElementById('status-dot');
        const elStatusText = document.getElementById('status-text');
        const elReconnectBanner = document.getElementById('reconnect-banner');

        // ============================================
        // UTILITIES
        // ============================================
        const formatTime = (seconds) => {
            if (!seconds || isNaN(seconds)) return '00:00';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            if (h > 0) {
                return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            }
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        };

        // Clean up movie filename for display
        const cleanFilename = (filename) => {
            if (!filename || filename === 'No Media') return filename;

            let name = filename;

            // Remove file extension
            name = name.replace(/\.(mp4|mkv|avi|mov|webm|wmv|flv|m4v|ts|m2ts)$/i, '');

            // Remove common release tags (case insensitive)
            const tagsToRemove = [
                /\(@[^)]+\)/gi,           // (@Intermedia), (@YIFY), etc.
                /\[[^\]]+\]/g,             // [720p], [1080p], [x264], etc.
                /\(1080p\)/gi,
                /\(720p\)/gi,
                /\(2160p\)/gi,
                /\(4K\)/gi,
                /\bWEB-DL\b/gi,
                /\bWEBRip\b/gi,
                /\bBluRay\b/gi,
                /\bBDRip\b/gi,
                /\bHDRip\b/gi,
                /\bDVDRip\b/gi,
                /\bx264\b/gi,
                /\bx265\b/gi,
                /\bH\.?264\b/gi,
                /\bH\.?265\b/gi,
                /\bHEVC\b/gi,
                /\bAAC\b/gi,
                /\bAC3\b/gi,
                /\bDTS\b/gi,
                /\bDDP?\d*\.?\d*\b/gi,     // DDP2.0, DDP5.1, etc.
                /\bAMZN\b/gi,
                /\bNF\b/gi,
                /\bHBO\b/gi,
                /- [A-Z]+$/i,              // - SPARKS, - YIFY, etc.
            ];

            tagsToRemove.forEach(regex => {
                name = name.replace(regex, '');
            });

            // Replace dots and underscores with spaces
            name = name.replace(/[._]/g, ' ');

            // Extract year if present (keep it nice)
            const yearMatch = name.match(/\b(19\d{2}|20\d{2})\b/);
            let year = '';
            if (yearMatch) {
                year = yearMatch[1];
                // Remove year from title temporarily
                name = name.replace(yearMatch[0], '');
            }

            // Clean up multiple spaces and trim
            name = name.replace(/\s+/g, ' ').trim();

            // Add year back in parentheses if found
            if (year && !name.includes(year)) {
                name = `${name} (${year})`;
            }

            return name || filename;
        };

        const vibrate = (intensity = 'light') => {
            if (!navigator.vibrate) return;
            // Different haptic intensities
            const patterns = {
                light: 5,      // Quick tap
                medium: 15,    // Button press
                heavy: 30,     // Important action
                double: [10, 50, 10] // Confirmation
            };
            navigator.vibrate(patterns[intensity] || 5);
        };

        // Add haptic feedback to ALL buttons and interactive elements
        document.addEventListener('DOMContentLoaded', () => {
            // All buttons get haptic on touchstart
            document.querySelectorAll('button, .btn-circle, .drawer-btn, .track-row').forEach(btn => {
                btn.addEventListener('touchstart', () => vibrate('light'), { passive: true });
            });
        });

        // Also add haptic to dynamically created elements
        document.addEventListener('touchstart', (e) => {
            if (e.target.closest('button, .btn-circle, .drawer-btn, .track-row, .modal-close')) {
                vibrate('light');
            }
        }, { passive: true });

        // ============================================
        // CONNECTION
        // ============================================
        function connect() {
            if (socket) {
                socket.disconnect();
            }

            socket = io({
                reconnection: true,
                reconnectionAttempts: MAX_RECONNECT_ATTEMPTS,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                timeout: 20000,
                // Use polling first for better mobile compatibility
                transports: ['polling', 'websocket'],
                upgrade: true,
                forceNew: true
            });

            // Connection events
            socket.on('connect', () => {
                console.log('[Remote] Connected!');
                isConnected = true;
                reconnectAttempts = 0;
                updateConnectionUI('connected');

                // Request initial state
                socket.emit('request-state');
                socket.emit('get-sys-info');
            });

            socket.on('disconnect', (reason) => {
                console.log('[Remote] Disconnected:', reason);
                isConnected = false;
                if (isQuitting) {
                    showAppClosedUI();
                    return;
                }
                updateConnectionUI('disconnected');
            });

            socket.on('connect_error', (error) => {
                console.log('[Remote] Connection error:', error.message);
                reconnectAttempts++;
                updateConnectionUI('connecting');
            });

            socket.on('reconnect_attempt', (attempt) => {
                console.log('[Remote] Reconnecting... attempt', attempt);
                updateConnectionUI('connecting');
            });

            socket.on('reconnect', () => {
                console.log('[Remote] Reconnected!');
                isConnected = true;
                updateConnectionUI('connected');
                socket.emit('request-state');
            });

            // State events
            socket.on('full-state', (state) => {
                console.log('[Remote] Full state received:', state);
                handleFullState(state);
            });

            socket.on('state-update', (updates) => {
                handleStateUpdate(updates);
            });

            socket.on('status', (data) => {
                console.log('[Remote] Status:', data);
            });

            // System Info
            socket.on('sys-info', (data) => {
                const toggle = document.getElementById('autolaunch-toggle');
                if (toggle) toggle.checked = data.autoLaunch;
            });



            // Stream availability for Watch on Phone
            socket.on('stream-available', (data) => {
                console.log('[Remote] Stream available:', data);
                streamAvailable = data.available;
                updateStreamBadge(data.available);
            });
        }

        function updateConnectionUI(status) {
            elStatusDot.className = 'status-dot';
            elReconnectBanner.classList.remove('show');

            switch (status) {
                case 'connected':
                    elStatusDot.classList.remove('connecting', 'disconnected');
                    elStatusText.textContent = 'Connected';
                    break;
                case 'connecting':
                    elStatusDot.classList.add('connecting');
                    elStatusText.textContent = `Reconnecting (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})...`;
                    elReconnectBanner.classList.add('show');
                    elReconnectBanner.textContent = `Reconnecting... (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`;
                    break;
                case 'disconnected':
                    elStatusDot.classList.add('disconnected');
                    elStatusText.textContent = 'Disconnected';
                    elReconnectBanner.classList.add('show');
                    elReconnectBanner.textContent = 'Connection lost. Tap to retry.';
                    break;
            }
        }

        function showAppClosedUI() {
            document.body.innerHTML = `
                <div style="display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh; background:var(--bg); color:var(--text); text-align:center; padding:20px; font-family: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;">
                    <div style="width:80px; height:80px; background:rgba(239, 68, 68, 0.1); border-radius:50%; display:flex; align-items:center; justify-content:center; margin-bottom:24px;">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
                            <line x1="12" y1="2" x2="12" y2="12"></line>
                        </svg>
                    </div>
                    <h2 style="margin:0 0 12px 0; font-size:24px; font-weight:700;">App Closed</h2>
                    <p style="color:var(--text-dim); margin:0; line-height:1.5; font-size:15px;">NauticPlayer has been shut down.<br>You can safely close this tab.</p>
                </div>
            `;

            // Attempt to close silently just in case supported
            try { window.close(); } catch (e) { }
        }

        // ============================================
        // STATE HANDLERS
        // ============================================
        function handleFullState(state) {
            playerState = { ...playerState, ...state };
            updateAllUI();
        }

        function handleStateUpdate(updates) {
            Object.assign(playerState, updates);

            // Update only changed UI elements
            if ('time' in updates) updateTimeUI();
            if ('duration' in updates) updateDurationUI();
            if ('paused' in updates) updatePlayPauseUI();
            if ('volume' in updates) updateVolumeUI();
            if ('filename' in updates) updateTitleUI();
            if ('tracks' in updates) updateTracksUI();
        }

        function updateAllUI() {
            updateTimeUI();
            updateDurationUI();
            updatePlayPauseUI();
            updateVolumeUI();
            updateTitleUI();
            updateTracksUI();
        }

        function updateTimeUI() {
            if (isDraggingSeek) return;

            elTime.textContent = formatTime(playerState.time);
            elTimeCurrent.textContent = formatTime(playerState.time);

            if (playerState.duration > 0) {
                elSeek.value = (playerState.time / playerState.duration) * 1000;
            }
            lastTimeUpdate = Date.now();
        }

        function updateDurationUI() {
            elTimeDuration.textContent = formatTime(playerState.duration);
        }

        function updatePlayPauseUI() {
            document.getElementById('icon-play').style.display = playerState.paused ? 'block' : 'none';
            document.getElementById('icon-pause').style.display = playerState.paused ? 'none' : 'block';
        }

        function updateVolumeUI() {
            elVol.value = playerState.volume;
        }

        function updateTitleUI() {
            elTitle.textContent = cleanFilename(playerState.filename) || 'No Media';
        }

        function updateTracksUI() {
            const audioCount = playerState.tracks.filter(t => t.type === 'audio').length;
            const subCount = playerState.tracks.filter(t => t.type === 'sub').length;
            document.getElementById('count-audio').textContent = audioCount;
            document.getElementById('count-sub').textContent = subCount;
        }

        // ============================================
        // COMMANDS
        // ============================================
        function quitApp() {
            if (confirm('Quit NauticPlayer?')) {
                vibrate('medium');
                isQuitting = true;
                // Send quit command
                if (socket && isConnected) {
                    socket.emit('cmd', { action: 'quit' });
                }

                // Show closed UI immediately
                showAppClosedUI();

                // Disconnect socket to prevent reconnection attempts
                if (socket) {
                    socket.disconnect();
                }

                // Try to close window (might be blocked by browser)
                try {
                    window.close();
                } catch (e) {
                    // Ignore
                }
            }
        }

        function send(action, value) {
            vibrate();
            if (socket && isConnected) {
                socket.emit('cmd', { action, value });
            }
        }

        function requestSync() {
            vibrate();
            if (socket) {
                socket.emit('request-state');
            }
            toggleDrawer();
        }

        function toggleAutoLaunch(checked) {
            vibrate('light');
            if (socket && isConnected) {
                socket.emit('toggle-autolaunch', checked);
            }
        }



        // ============================================
        // DRAWER
        // ============================================
        function toggleDrawer() {
            document.getElementById('drawer').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('open');
        }

        // ============================================
        // TRACK MODAL
        // ============================================
        function openTracks(type) {
            const list = playerState.tracks.filter(t => t.type === type);
            const container = document.getElementById('track-container');
            container.innerHTML = '';

            document.getElementById('modal-title').textContent = type === 'audio' ? 'Audio Tracks' : 'Subtitles';

            if (list.length === 0) {
                container.innerHTML = '<div style="padding:40px; text-align:center; color:var(--text-dim)">No tracks available</div>';
            } else {
                // Add "None" option for subtitles
                if (type === 'sub') {
                    const noneRow = document.createElement('div');
                    noneRow.className = 'track-row';
                    noneRow.textContent = 'None (Disable)';
                    noneRow.onclick = () => {
                        send('command', ['set_property', 'sid', 'no']);
                        closeModal();
                    };
                    container.appendChild(noneRow);
                }

                list.forEach(track => {
                    const row = document.createElement('div');
                    row.className = `track-row ${track.selected ? 'selected' : ''}`;
                    row.textContent = `${track.id}: ${track.title || track.lang || 'Unknown'}`;
                    row.onclick = () => {
                        send('command', ['set_property', type === 'audio' ? 'aid' : 'sid', track.id]);
                        closeModal();
                    };
                    container.appendChild(row);
                });
            }

            document.getElementById('track-modal').classList.add('show');
            toggleDrawer();
        }

        function closeModal() {
            document.getElementById('track-modal').classList.remove('show');
        }

        // ============================================
        // WATCH MODE (Stream video to phone)
        // ============================================
        let streamAvailable = false;

        async function openWatchMode(forceTranscode = false) {
            vibrate('medium');

            const watchMode = document.getElementById('watch-mode');
            const watchContainer = document.getElementById('watch-container');
            const watchVideo = document.getElementById('watch-video');
            const watchTitle = document.getElementById('watch-title');

            // Show watch mode with loading spinner
            watchMode.classList.add('show');
            watchTitle.textContent = forceTranscode ? 'Preparing Transcode...' : 'Loading...';
            watchContainer.innerHTML = `
                <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%;">
                    <div class="spinner"></div>
                    <p style="margin-top:16px; color:rgba(255,255,255,0.6);">${forceTranscode ? 'Starting Transcoder...' : 'Connecting to stream...'}</p>
                </div>
            `;

            try {
                // Check if streaming is available
                const response = await fetch('/stream-info');
                const info = await response.json();

                console.log('[Watch] Stream info:', info);

                if (!info.available) {
                    watchContainer.innerHTML = `
                        <div class="watch-error">
                            <h3>Cannot Stream</h3>
                            <p>${info.error || 'This format is not supported.'}</p>
                        </div>
                    `;
                    return;
                }

                // Set video source and title
                watchTitle.textContent = info.filename;

                // Add transcoding indicator if needed
                const isTranscoding = info.needsTranscode || forceTranscode;
                if (isTranscoding) {
                    watchTitle.textContent = info.filename + ' (Transcoding...)';
                }

                watchContainer.innerHTML = `<video class="watch-video" id="watch-video" controls playsinline autoplay></video>`;

                const video = document.getElementById('watch-video');

                // Use appropriate endpoint based on format
                if (isTranscoding) {
                    const startTime = Math.floor(info.currentTime || 0);

                    // Fetch HLS playlist URL
                    fetch(`/stream-transcode?t=${startTime}`)
                        .then(res => {
                            if (!res.ok) throw new Error('Transcoding failed');
                            return res.json();
                        })
                        .then(data => {
                            // Use HLS.js if supported (Chrome, Firefox, Android)
                            if (Hls.isSupported()) {
                                console.log('[Watch] using HLS.js');
                                const hls = new Hls({
                                    debug: false,
                                    enableWorker: true
                                });
                                hls.loadSource(data.url);
                                hls.attachMedia(video);
                                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                                    video.play().catch(e => console.warn('Auto-play blocked:', e));
                                });
                                // Keep reference to destroy later
                                video.hls = hls;
                            }
                            // Use native HLS (Safari iOS/Mac)
                            else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                                console.log('[Watch] using native HLS');
                                video.src = data.url;
                                video.addEventListener('loadedmetadata', () => {
                                    video.play().catch(e => console.warn('Auto-play blocked:', e));
                                });
                            } else {
                                throw new Error('HLS not supported on this browser');
                            }
                        })
                        .catch(err => {
                            console.error('Transcoding setup error:', err);
                            watchContainer.innerHTML = `
                                <div class="watch-error">
                                    <h3>Transcoding Error</h3>
                                    <p>${err.message}</p>
                                </div>
                            `;
                        });
                } else {
                    // Native format - direct stream with seeking
                    video.src = '/stream';

                    // Seek to current position
                    video.addEventListener('loadedmetadata', () => {
                        if (info.currentTime > 0) {
                            video.currentTime = info.currentTime;
                        }
                        if (!info.paused) {
                            video.play().catch(() => { });
                        }
                    });
                }

                // Error handling with detailed logging
                video.addEventListener('error', (e) => {
                    const mediaError = video.error;
                    let errorMsg = 'Unknown error';
                    if (mediaError) {
                        switch (mediaError.code) {
                            case MediaError.MEDIA_ERR_ABORTED: errorMsg = 'Playback aborted'; break;
                            case MediaError.MEDIA_ERR_NETWORK: errorMsg = 'Network error'; break;
                            case MediaError.MEDIA_ERR_DECODE: errorMsg = 'Format not supported (Decode Error)'; break;
                            case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED: errorMsg = 'Format not supported'; break;
                        }
                    }
                    console.error('Video error:', errorMsg, mediaError);

                    // Offer transcoding fallback
                    watchContainer.innerHTML = `
                        <div class="watch-error">
                            <h3>Playback Error</h3>
                            <p>${errorMsg}</p>
                            <p style="font-size:12px; margin:8px 0; opacity:0.7">
                                This file type (MP4/MKV) might use a codec not supported by your mobile browser.
                            </p>
                            <button class="drawer-btn" style="margin-top:16px; background:var(--primary); color:#000" onclick="openWatchMode(true)">
                                <svg class="icon-stroke" viewBox="0 0 24 24"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
                                Try Transcoding
                            </button>
                        </div>
                    `;
                });

            } catch (err) {
                console.error('Stream error:', err);
                watchContainer.innerHTML = `
                    <div class="watch-error">
                        <h3>Connection Error</h3>
                        <p>Could not connect to the stream server.</p>
                    </div>
                `;
            }
        }

        function closeWatchMode() {
            vibrate();
            const watchMode = document.getElementById('watch-mode');
            const watchVideo = document.getElementById('watch-video');

            // Pause and unload video
            if (watchVideo) {
                watchVideo.pause();
                watchVideo.removeAttribute('src'); // Unload

                // Destroy HLS instance if exists
                if (watchVideo.hls) {
                    watchVideo.hls.destroy();
                    delete watchVideo.hls;
                }
            }

            // Reset container
            document.getElementById('watch-container').innerHTML =
                '<video class="watch-video" id="watch-video" controls playsinline></video>';

            watchMode.classList.remove('show');
        }

        // Listen for stream availability updates
        function updateStreamBadge(available) {
            const badge = document.getElementById('stream-badge');
            if (badge) {
                badge.style.display = available ? 'inline' : 'none';
            }
        }

        // Toggle fullscreen for the video player
        function toggleWatchFullscreen() {
            vibrate('medium');
            const video = document.getElementById('watch-video');
            const container = document.getElementById('watch-container');

            if (!video) return;

            // Try video element fullscreen first (better for mobile)
            if (video.requestFullscreen) {
                video.requestFullscreen();
            } else if (video.webkitRequestFullscreen) {
                video.webkitRequestFullscreen();
            } else if (video.webkitEnterFullscreen) {
                // iOS Safari specific
                video.webkitEnterFullscreen();
            } else if (container.requestFullscreen) {
                // Fallback to container
                container.requestFullscreen();
            } else if (container.webkitRequestFullscreen) {
                container.webkitRequestFullscreen();
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================

        // Seek bar
        elSeek.addEventListener('input', (e) => {
            isDraggingSeek = true;
            const percent = e.target.value / 1000;
            const time = percent * playerState.duration;
            elTime.textContent = formatTime(time);
            elTimeCurrent.textContent = formatTime(time);
        });

        elSeek.addEventListener('change', (e) => {
            isDraggingSeek = false;
            const percent = e.target.value / 10; // Convert to 0-100
            send('command', ['seek', percent, 'absolute-percent']);
        });

        // Volume slider
        elVol.addEventListener('input', (e) => {
            send('volume', parseInt(e.target.value));
        });

        // Reconnect banner tap
        elReconnectBanner.addEventListener('click', () => {
            reconnectAttempts = 0;
            connect();
        });

        // Prevent zoom on double tap - using smarter approach
        // Don't globally prevent default, only on specific elements
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            // Prevent double-tap zoom, but allow normal taps
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, { passive: false });

        // ============================================
        // SMOOTH TIME INTERPOLATION
        // ============================================
        let interpolationFrame = null;

        function startTimeInterpolation() {
            function interpolate() {
                if (!isDraggingSeek && !playerState.paused && playerState.duration > 0) {
                    const elapsed = (Date.now() - lastTimeUpdate) / 1000;
                    const interpolatedTime = playerState.time + elapsed;

                    if (interpolatedTime <= playerState.duration) {
                        elTime.textContent = formatTime(interpolatedTime);
                        elTimeCurrent.textContent = formatTime(interpolatedTime);
                        elSeek.value = (interpolatedTime / playerState.duration) * 1000;
                    }
                }
                interpolationFrame = requestAnimationFrame(interpolate);
            }
            interpolate();
        }

        // ============================================
        // INIT
        // ============================================
        connect();
        startTimeInterpolation();

        // ============================================
        // PWA INSTALL PROMPT
        // ============================================
        let deferredPrompt = null;
        const installPrompt = document.getElementById('install-prompt');
        const installBtn = document.getElementById('install-btn');

        // Check if already installed or dismissed
        function isStandalone() {
            return window.matchMedia('(display-mode: standalone)').matches
                || window.navigator.standalone === true;
        }

        function showInstallPrompt() {
            // Don't show if already standalone, already dismissed, or on desktop
            if (isStandalone()) return;
            if (localStorage.getItem('installDismissed')) return;
            if (!/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) return;

            installPrompt.classList.add('show');

            // Update button text for iOS
            if (/iPhone|iPad|iPod/i.test(navigator.userAgent) && !deferredPrompt) {
                installBtn.textContent = 'How to Install';
            }
        }

        function dismissInstallPrompt() {
            vibrate();
            installPrompt.classList.remove('show');
            localStorage.setItem('installDismissed', 'true');
        }

        function installApp() {
            vibrate('medium');

            if (deferredPrompt) {
                // Android Chrome - native install prompt
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        installPrompt.classList.remove('show');
                    }
                    deferredPrompt = null;
                });
            } else if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                // iOS - show onboarding (will be replaced with visual guide)
                showIOSInstallGuide();
            } else {
                // Other browsers
                alert('To install:\n\n1. Open browser menu\n2. Select "Add to Home Screen" or "Install App"');
            }
        }

        // iOS Install Guide - Show visual onboarding
        let currentOnboardingStep = 1;
        const totalOnboardingSteps = 6;

        function showIOSInstallGuide() {
            currentOnboardingStep = 1;
            updateOnboardingUI();
            document.getElementById('ios-onboarding').classList.add('show');
            installPrompt.classList.remove('show');
        }

        function closeOnboarding() {
            vibrate();
            document.getElementById('ios-onboarding').classList.remove('show');
        }

        function nextOnboardingStep() {
            vibrate();
            if (currentOnboardingStep < totalOnboardingSteps) {
                currentOnboardingStep++;
                updateOnboardingUI();
            }
        }

        function prevOnboardingStep() {
            vibrate();
            if (currentOnboardingStep > 1) {
                currentOnboardingStep--;
                updateOnboardingUI();
            }
        }

        function updateOnboardingUI() {
            // Update step info
            document.getElementById('onboarding-step-info').textContent = `Step ${currentOnboardingStep} of ${totalOnboardingSteps}`;

            // Update slides
            document.querySelectorAll('.onboarding-slide').forEach((slide, idx) => {
                slide.classList.toggle('active', idx + 1 === currentOnboardingStep);
            });

            // Update dots
            document.querySelectorAll('.onboarding-dot').forEach((dot, idx) => {
                dot.classList.toggle('active', idx + 1 === currentOnboardingStep);
            });

            // Update buttons
            document.getElementById('onboarding-prev').disabled = currentOnboardingStep === 1;
            const nextBtn = document.getElementById('onboarding-next');
            if (currentOnboardingStep === totalOnboardingSteps) {
                nextBtn.textContent = 'Done';
                nextBtn.onclick = closeOnboarding;
            } else {
                nextBtn.textContent = 'Next';
                nextBtn.onclick = nextOnboardingStep;
            }
        }

        // Capture the install prompt (Chrome/Edge on Android)
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallPrompt();
        });

        // Show prompt after short delay if not captured
        setTimeout(() => {
            if (!deferredPrompt && !isStandalone()) {
                showInstallPrompt();
            }
        }, 3000);

        let pendingResumePos = 0;

        socket.on('resume-prompt', (state) => {
            const panel = document.getElementById('resume-panel');
            if (state.visible) {
                pendingResumePos = state.position;
                document.getElementById('resume-text').innerText = formatTime(state.position);
                panel.classList.add('show');
                vibrate('medium');
            } else {
                panel.classList.remove('show');
            }
        });

        window.confirmResume = function () {
            send('resume', pendingResumePos);
            document.getElementById('resume-panel').classList.remove('show');
        }

        window.dismissResume = function () {
            send('dismiss-resume', null);
            document.getElementById('resume-panel').classList.remove('show');
        }

        /* === FILE EXPLORER === */

        // Define variables in global scope but initialize on DOM load if needed
        let explorerModal, explorerList, explorerBreadcrumbs;
        let currentPath = '';

        document.addEventListener('DOMContentLoaded', () => {
            explorerModal = document.getElementById('explorer-modal');
            explorerList = document.getElementById('explorer-list');
            explorerBreadcrumbs = document.getElementById('explorer-breadcrumbs');
            console.log('[Explorer] Initialized elements', { explorerModal, explorerList });
        });

        // Attach functions to window to ensure visibility to inline event handlers
        window.openExplorer = async function () {
            if (!explorerModal) explorerModal = document.getElementById('explorer-modal');
            if (explorerModal) {
                explorerModal.classList.add('show');

                // Try to load downloads folder first
                renderLoading();
                try {
                    const res = await fetch('/api/defaults');
                    const defaults = await res.json();
                    if (defaults.downloads) {
                        window.loadPath(defaults.downloads)
                    } else {
                        window.loadDrives();
                    }
                } catch (e) {
                    console.error('Failed to defaults:', e);
                    window.loadDrives();
                }
            } else {
                console.error('Modal not found');
            }
        }

        window.closeExplorer = function () {
            if (explorerModal) explorerModal.classList.remove('show');
        }

        window.loadDrives = async function () {
            renderLoading();
            try {
                const res = await fetch('/api/drives');
                const drives = await res.json();
                console.log('[Explorer] Drives loaded:', drives);

                // Ensure drives is an array
                const items = Array.isArray(drives) ? drives : [];

                renderItems({
                    parent: null,
                    items: items.map(d => ({
                        name: `${d.name} (${d.description})`,
                        path: d.name,
                        isDir: true,
                        isDrive: true
                    }))
                });
                updateBreadcrumbs(null);
            } catch (e) {
                console.error('Failed to load drives:', e);
                if (explorerList) explorerList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--danger)">Failed to load drives. Check console.</div>';
            }
        }

        window.loadPath = async function (path) {
            console.log('[Explorer] Loading path:', path);
            renderLoading();
            try {
                const res = await fetch(`/api/files?path=${encodeURIComponent(path)}`);
                if (!res.ok) throw new Error('Failed to load');
                const data = await res.json();
                renderItems(data);
                updateBreadcrumbs(data.path);
                currentPath = data.path;
            } catch (e) {
                console.error('Failed to load path:', e);
                showError('Access denied or invalid path');
                window.loadDrives(); // Fallback
            }
        }

        function renderLoading() {
            if (explorerList) {
                explorerList.innerHTML = `
                    <div style="display: flex; justify-content: center; padding: 40px;">
                        <div class="spinner"></div>
                    </div>
                `;
            }
        }

        function renderItems(data) {
            if (!explorerList) return;
            let html = '';

            // Add "Up" folder if not root/drives
            if (data.parent) {
                // Use data-path attribute to avoid quote escaping hell
                html += `
                    <div class="file-item" data-type="dir" data-path="${escapeHtml(data.parent)}">
                        <svg class="file-icon folder" viewBox="0 0 24 24"><path d="M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11z"/></svg>
                        <div class="file-info">
                            <div class="file-name">..</div>
                            <div class="file-meta">Parent Directory</div>
                        </div>
                    </div>
                `;
            } else if (data.parent === null && (!data.items.length || !data.items[0]?.isDrive)) {
                html += `
                    <div class="file-item" onclick="window.loadDrives()">
                        <svg class="file-icon folder" viewBox="0 0 24 24"><path d="M3 7v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-6l-2-2H5a2 2 0 0 0-2 2z"></path></svg>
                        <div class="file-info">
                            <div class="file-name">My PC</div>
                            <div class="file-meta">Drives</div>
                        </div>
                    </div>
                `;
            }

            if (data.items.length === 0) {
                html += '<div style="padding: 20px; text-align: center; opacity: 0.5">Empty folder</div>';
            }

            data.items.forEach(item => {
                const icon = item.isDir
                    ? `<svg class="file-icon folder" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>`
                    : `<svg class="file-icon ${item.isVideo ? 'video' : ''}" viewBox="0 0 24 24"><path fill="currentColor" d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 2l5 5h-5V4zM6 20V4h5v7h7v9H6z"/></svg>`;

                const type = item.isDir ? 'dir' : 'file';
                const meta = item.isDir ? 'Folder' : (item.isVideo ? 'Video File' : 'File');

                html += `
                    <div class="file-item" data-type="${type}" data-path="${escapeHtml(item.path)}">
                        ${icon}
                        <div class="file-info">
                            <div class="file-name">${escapeHtml(item.name)}</div>
                            <div class="file-meta">${meta}</div>
                        </div>
                    </div>
                `;
            });

            explorerList.innerHTML = html;

            // Attach event listeners to new items
            explorerList.querySelectorAll('.file-item[data-path]').forEach(el => {
                el.addEventListener('click', () => {
                    const path = el.getAttribute('data-path');
                    const type = el.getAttribute('data-type');
                    if (type === 'dir') {
                        window.loadPath(path);
                    } else {
                        window.openFile(path);
                    }
                });
            });
        }

        // Helper to escape HTML special chars in attributes
        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function updateBreadcrumbs(path) {
            if (explorerBreadcrumbs) {
                if (!path) {
                    explorerBreadcrumbs.innerHTML = '<span class="breadcrumb-item" onclick="window.loadDrives()">My PC</span>';
                    return;
                }
                explorerBreadcrumbs.innerHTML = `
                    <span class="breadcrumb-item" onclick="window.loadDrives()">My PC</span>
                    <span class="breadcrumb-sep">/</span>
                    <span class="breadcrumb-item" style="color: var(--text-dim); cursor: default">${escapeHtml(path)}</span>
                `;
            }
        }

        window.openFile = function (path) {
            window.closeExplorer();
            send('loadfile', path);
        }

    </script>
</body>

</html>